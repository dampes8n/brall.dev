class BTimeline extends(window.BJsonLoader||HTMLElement){constructor(){super();this.events=[];this.filters={academic:true,employed:true,independent:false,personal:false,major:false};}
connectedCallback(){this.filters.academic=this.hasAttribute('academic')?this.getAttribute('academic')!=='false':true;this.filters.employed=this.hasAttribute('employed')?this.getAttribute('employed')!=='false':true;this.filters.independent=this.hasAttribute('independent')?this.getAttribute('independent')!=='false':false;this.filters.personal=this.hasAttribute('personal')?this.getAttribute('personal')!=='false':false;const defaultMajor=this.hasAttribute('default-major');this.filters.major=defaultMajor||(this.hasAttribute('major')?this.getAttribute('major')!=='false':false);this.fullHeight=this.hasAttribute('full-height');if(this.fullHeight){this.classList.add('timeline-full-height');}
this.renderStructure();this.loadEvents();}
renderStructure(){if(!this.querySelector('.timeline-wrapper')){this.innerHTML=`
                <div class="timeline-wrapper">
                    <div class="timeline-filters">
                        <h2>Filter by Domain</h2>
                        <div class="filter-controls">
                            <label><input type="checkbox" data-domain="academic" ${this.filters.academic ? 'checked' : ''}> <span class="filter-color academic"></span> Academic</label>
                            <label><input type="checkbox" data-domain="employed" ${this.filters.employed ? 'checked' : ''}> <span class="filter-color employed"></span> Employed</label>
                            <label><input type="checkbox" data-domain="independent" ${this.filters.independent ? 'checked' : ''}> <span class="filter-color independent"></span> Independent</label>
                            <label><input type="checkbox" data-domain="personal" ${this.filters.personal ? 'checked' : ''}> <span class="filter-color personal"></span> Personal</label>
                        </div>
                        <div class="filter-separator"></div>
                        <div class="filter-controls">
                            <label><input type="checkbox" data-domain="major" ${this.filters.major ? 'checked' : ''}> <span class="filter-major">★</span> Major</label>
                        </div>
                    </div>
                    <div class="timeline-content-area">
                        <div class="timeline-container">
                            <p>Loading timeline...</p>
                        </div>
                    </div>
                </div>
            `;this.attachFilterListeners();}}
async loadEvents(){try{this.events=await this.loadJson('data/timeline-events.json','events');this.render();}catch(e){this.showError('Error loading timeline events.');}}
render(){if(this.events.length===0){this.renderStructure();return;}
const existingWrapper=this.querySelector('.timeline-wrapper');if(!existingWrapper){this.renderStructure();}
this.renderTimeline(this.events).then(html=>{const container=this.querySelector('.timeline-container');if(container){container.innerHTML=html;this.updateVisibility();}});}
parseDate(dateStr){if(!dateStr||dateStr==='null'){return new Date(0);}
const parts=dateStr.split('-');if(parts.length===3){return new Date(parts[0],parseInt(parts[1])-1,parseInt(parts[2]));}else if(parts.length===2){const part2=parts[1].toLowerCase();if(part2==='early'){return new Date(parts[0],0,1);}else if(part2==='mid'){return new Date(parts[0],5,15);}else if(part2==='late'){return new Date(parts[0],11,15);}else if(part2==='spring'){return new Date(parts[0],2,21);}else if(part2==='summer'){return new Date(parts[0],5,21);}else if(part2==='fall'){return new Date(parts[0],8,22);}else if(part2==='winter'){return new Date(parts[0],11,21);}else{const month=parseInt(parts[1]);if(!isNaN(month)){return new Date(parts[0],month-1,1);}
return new Date(parts[0],0,1);}}else{return new Date(parts[0],0,1);}}
async renderTimeline(events){let projects=[];try{projects=await this.loadJson('data/projects.json','projects');}catch(e){console.warn('Failed to load projects for timeline:',e);}
const sortedEvents=[...events].sort((a,b)=>{const dateA=this.parseDate(a.date);const dateB=this.parseDate(b.date);return dateB-dateA;});const eventHtmls=sortedEvents.map((event,index)=>this.renderEvent(event,index,projects));return eventHtmls.join('');}
renderEvent(event,index,projects=[]){const date=BDate.formatDate(event.date||'Unknown');const domain=event.domain||'';const domainLower=domain.toLowerCase();const subdomain=event.subdomain||'';const project=event.project||'';const title=event.title||'';const slug=event.slug||'';const isMajor=event.major===true;const subdomainLink=subdomain?this.slugify(subdomain):'';const subdomainHtml=subdomain?`<a href="#!/subdomains/${subdomainLink}" class="tag">${this.escapeHtml(subdomain)}</a>`:'';let projectHtml='';if(project){const relatedProject=projects.find(p=>p.title&&p.title.toLowerCase()===project.toLowerCase());if(relatedProject){projectHtml=`<a href="#!/projects/${relatedProject.slug}" class="tag">${this.escapeHtml(project)}</a>`;}else{projectHtml=`<span class="tag">${this.escapeHtml(project)}</span>`;}}
let skillsetsHtml='';if(event.skillsets&&event.skillsets.length>0){skillsetsHtml=event.skillsets.map(skillset=>{const skillsetSlug=this.slugify(skillset);return`<a href="#!/skillsets/${skillsetSlug}" class="tag" style="font-size: 0.75rem;">${this.escapeHtml(skillset)}</a>`;}).join('');}
const majorClass=isMajor?' timeline-event-major':'';const markerContent='<div class="timeline-marker-outer"></div><div class="timeline-marker-inner"></div>';const starPrefix=isMajor?'<span class="timeline-title-star">★</span> ':'';return`
            <div class="timeline-event domain-${domainLower}${majorClass}" data-domain="${domainLower}" data-major="${isMajor}">
                <div class="timeline-marker">
                    ${markerContent}
                </div>
                <div class="timeline-content">
                    <time>${date}</time>
                    ${title ? `<h3>${starPrefix}${slug?`<a href="#!/timeline-events/${slug}">${this.escapeHtml(title)}</a>`:this.escapeHtml(title)}</h3>` : ''}
                    <nav class="tags">
                        ${domain ? `<span class="tag timeline-domain">${this.escapeHtml(domain)}</span>` : ''}
                        ${subdomainHtml}
                        ${projectHtml}
                    </nav>
                    ${skillsetsHtml ? `<nav class="tags">${skillsetsHtml}</nav>` : ''}
                </div>
            </div>
        `;}
attachFilterListeners(){const checkboxes=this.querySelectorAll('input[type="checkbox"][data-domain]');checkboxes.forEach(checkbox=>{checkbox.addEventListener('change',(e)=>{const domain=e.target.getAttribute('data-domain');this.filters[domain]=e.target.checked;this.updateVisibility();this.updateTimelineLineHeight();});});}
updateVisibility(){const events=this.querySelectorAll('.timeline-event');events.forEach(event=>{const domain=event.getAttribute('data-domain');const isMajor=event.getAttribute('data-major')==='true';const domainVisible=this.filters[domain]||false;const majorFilterActive=this.filters.major;const isVisible=domainVisible&&(!majorFilterActive||isMajor);if(isVisible){event.classList.remove('timeline-event-hidden');}else{event.classList.add('timeline-event-hidden');}});const visibleEvents=this.querySelectorAll('.timeline-event:not(.timeline-event-hidden)');events.forEach(event=>event.classList.remove('timeline-last-visible'));if(visibleEvents.length>0){visibleEvents[visibleEvents.length-1].classList.add('timeline-last-visible');}
const container=this.querySelector('.timeline-container');let noEventsMsg=container.querySelector('.no-events-message');if(visibleEvents.length===0){if(!noEventsMsg){noEventsMsg=document.createElement('p');noEventsMsg.className='no-events-message';noEventsMsg.textContent='No events match the selected filters.';container.appendChild(noEventsMsg);}}else{if(noEventsMsg){noEventsMsg.remove();}}}
updateTimelineLineHeight(){}}
customElements.define('b-timeline',BTimeline);