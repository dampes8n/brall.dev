class BFlavorSelector extends HTMLElement{constructor(){super();this.flavorNames={'core':'Core','millennial-great':'Millennial Great','wickedpedia':'Wickedpedia','litrpg':'LitRPG','offices-overseers':'Offices and Overseers','terminally-ill':'Terminally Ill','vhscary':'VHScary'};this.flavorPaths={'millennial-great':'css/flavors/millennial-great.css','wickedpedia':'css/flavors/wickedpedia.css','litrpg':'css/flavors/litrpg.css','offices-overseers':'css/flavors/offices-overseers.css','terminally-ill':'css/flavors/terminally-ill.css','vhscary':'css/flavors/vhscary.css'};this.flavorScriptPaths={'terminally-ill':'js/flavors/terminally-ill.js'};this.currentFlavor=null;this.isInitialLoad=true;this.currentFlavorScript=null;}
getCookie(name){const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return parts.pop().split(';').shift();return null;}
setCookie(name,value,days=365){const date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));const expires=`expires=${date.toUTCString()}`;document.cookie=`${name}=${value};${expires};path=/`;}
getDefaultFlavor(){const prefersReducedMotion=window.matchMedia('(prefers-reduced-motion: reduce)').matches;if(prefersReducedMotion){return'millennial-great';}
const prefersDark=window.matchMedia('(prefers-color-scheme: dark)').matches;if(prefersDark){return'terminally-ill';}
return'core';}
fadeInBlinder(){return new Promise(resolve=>{const blinder=document.getElementById('flavor-binder');if(blinder){blinder.classList.add('active');setTimeout(resolve,100);}else{resolve();}});}
fadeOutBlinder(){return new Promise(resolve=>{const blinder=document.getElementById('flavor-binder');if(blinder){blinder.classList.remove('active');setTimeout(resolve,100);}else{resolve();}});}
async loadFlavorCss(flavor){if(flavor==='core'){return'';}
if(!this.flavorPaths[flavor]){throw new Error(`Unknown flavor: ${flavor}`);}
if(window.location.protocol==='file:'){throw new Error('File:// protocol detected. Please use a web server to load flavors.');}
if(window.TextCache){return await window.TextCache.fetch(this.flavorPaths[flavor]);}else{const response=await fetch(this.flavorPaths[flavor]);if(!response.ok){throw new Error(`HTTP ${response.status}`);}
return await response.text();}}
connectedCallback(){const cookieFlavor=this.getCookie('flavor');this.currentFlavor=cookieFlavor||this.getDefaultFlavor();this.switchFlavor(this.currentFlavor,true);this.render();this.attachEventListeners();}
switchFlavor(newFlavor,isInitial=false){const transitionStyle=document.getElementById('transition-style');const flavorStyle=document.getElementById('flavor-style');if(!transitionStyle||!flavorStyle){console.error('Flavor style elements not found');return;}
if(isInitial&&this.isInitialLoad){this.loadFlavorCss(newFlavor).then(css=>{flavorStyle.textContent=css;this.currentFlavor=newFlavor;this.setCookie('flavor',newFlavor);this.isInitialLoad=false;const select=this.querySelector('select');if(select){select.value=newFlavor;}
if(newFlavor==='core'){this.unloadFlavorScript();}else{this.loadFlavorScript(newFlavor);}
this.reloadLayers().catch(()=>{});}).catch(err=>{console.error(`Failed to load flavor ${newFlavor}:`,err);this.isInitialLoad=false;});return;}
this.fadeInBlinder().then(()=>this.loadFlavorCss(newFlavor)).then(css=>{flavorStyle.textContent=css;this.currentFlavor=newFlavor;this.setCookie('flavor',newFlavor);this.isInitialLoad=false;const select=this.querySelector('select');if(select){select.value=newFlavor;}
return new Promise(resolve=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{resolve();});});});}).then(()=>{return this.reloadLayers().catch(()=>{});}).then(()=>{if(newFlavor==='core'){this.unloadFlavorScript();}else{this.loadFlavorScript(newFlavor);}
return this.fadeOutBlinder();}).catch(err=>{console.error(`Failed to load flavor ${newFlavor}:`,err);transitionStyle.textContent='';this.isInitialLoad=false;this.fadeOutBlinder();});}
render(){const uniqueId=`flavor-select-${Math.random().toString(36).substr(2, 9)}`;const flavorIcons={'core':'fa-palette','millennial-great':'fa-couch','wickedpedia':'fa-book','litrpg':'fa-dice-d20','offices-overseers':'fa-briefcase','terminally-ill':'fa-terminal','vhscary':'fa-video'};this.innerHTML=`
            <label for="${uniqueId}">Flavor: </label>
            <select id="${uniqueId}" aria-label="Select flavor">
                ${Object.entries(this.flavorNames).map(([key, name]) => 
                    `<option value="${key}"${key===this.currentFlavor?'selected':''}data-icon="${flavorIcons[key] || 'fa-palette'}">${name}</option>`
                ).join('')}
            </select>
        `;}
async loadBackground(){if(window.location.protocol==='file:'){return;}
const bgContainer=document.getElementById('backgrounds');let bgLayer=bgContainer.querySelector('b-layer[type="background"]');const bgPath=`partials/flavors/${this.currentFlavor}.background.html`;try{let html;if(window.TextCache){try{html=await window.TextCache.fetch(bgPath);}catch(e){if(bgLayer){bgLayer.clear();}
return;}}else{const response=await fetch(bgPath);if(!response.ok){if(bgLayer){bgLayer.clear();}
return;}
html=await response.text();}
if(html){if(!bgLayer){bgLayer=document.createElement('b-layer');bgLayer.setAttribute('type','background');bgLayer.setAttribute('aria-hidden','true');bgContainer.appendChild(bgLayer);if(window.ComponentLoader){await window.ComponentLoader.load('b-layer').catch(()=>{});}}
await bgLayer.addLayer(html);}}catch(e){if(bgLayer){bgLayer.clear();}}}
async loadForeground(){if(window.location.protocol==='file:'){return;}
const fgContainer=document.getElementById('foregrounds');let fgLayer=fgContainer.querySelector('b-layer[type="foreground"]');const fgPath=`partials/flavors/${this.currentFlavor}.foreground.html`;try{let html;if(window.TextCache){try{html=await window.TextCache.fetch(fgPath);}catch(e){if(fgLayer){fgLayer.clear();}
return;}}else{const response=await fetch(fgPath);if(!response.ok){if(fgLayer){fgLayer.clear();}
return;}
html=await response.text();}
if(html){if(!fgLayer){fgLayer=document.createElement('b-layer');fgLayer.setAttribute('type','foreground');fgLayer.setAttribute('aria-hidden','true');fgContainer.appendChild(fgLayer);if(window.ComponentLoader){await window.ComponentLoader.load('b-layer').catch(()=>{});}}
await fgLayer.addLayer(html);}else{if(fgLayer){fgLayer.clear();}}}catch(e){if(fgLayer){fgLayer.clear();}}}
async reloadLayers(){await this.loadBackground();await this.loadForeground();}
loadFlavorScript(flavor){this.unloadFlavorScript();if(!this.flavorScriptPaths[flavor]){return;}
if(window.location.protocol==='file:'){console.warn('File:// protocol detected. Please use a web server to load flavor scripts.');return;}
const scriptPath=this.flavorScriptPaths[flavor];const placeholder=document.getElementById('flavor-script');if(!placeholder){console.warn('flavor-script placeholder element not found');return;}
const script=document.createElement('script');script.id='flavor-script';script.src=scriptPath;script.onerror=()=>{console.warn(`Failed to load flavor script: ${scriptPath}`);};placeholder.parentNode.replaceChild(script,placeholder);this.currentFlavorScript=scriptPath;}
unloadFlavorScript(){const scriptElement=document.getElementById('flavor-script');if(scriptElement&&scriptElement.src){const placeholder=document.createElement('script');placeholder.id='flavor-script';placeholder.src='';scriptElement.parentNode.replaceChild(placeholder,scriptElement);}
this.currentFlavorScript=null;}
attachEventListeners(){const select=this.querySelector('select');if(select){select.addEventListener('change',(e)=>{this.switchFlavor(e.target.value);});}}}
customElements.define('b-flavor-selector',BFlavorSelector);