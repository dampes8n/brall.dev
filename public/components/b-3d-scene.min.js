class B3DScene extends HTMLElement{constructor(){super();}
connectedCallback(){this.style.position='absolute';this.style.top='0';this.style.left='0';this.style.width='100%';this.style.height='100%';this.style.pointerEvents='none';this.style.zIndex='1';this.init();}
async init(){if(typeof THREE==='undefined'){if(window.loadThreeJs){try{await window.loadThreeJs();}catch(e){console.error('Failed to load Three.js:',e);return;}}else{console.error('Three.js is not loaded and loadThreeJs is not available');return;}}
(function(global){var module=global.noise={};function Grad(x,y,z){this.x=x;this.y=y;this.z=z;}
Grad.prototype.dot2=function(x,y){return this.x*x+this.y*y;};Grad.prototype.dot3=function(x,y,z){return this.x*x+this.y*y+this.z*z;};var grad3=[new Grad(1,1,0),new Grad(-1,1,0),new Grad(1,-1,0),new Grad(-1,-1,0),new Grad(1,0,1),new Grad(-1,0,1),new Grad(1,0,-1),new Grad(-1,0,-1),new Grad(0,1,1),new Grad(0,-1,1),new Grad(0,1,-1),new Grad(0,-1,-1)];var p=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];var perm=new Array(512);var gradP=new Array(512);module.seed=function(seed){if(seed>0&&seed<1){seed*=65536;}
seed=Math.floor(seed);if(seed<256){seed|=seed<<8;}
for(var i=0;i<256;i++){var v;if(i&1){v=p[i]^(seed&255);}else{v=p[i]^((seed>>8)&255);}
perm[i]=perm[i+256]=v;gradP[i]=gradP[i+256]=grad3[v%12];}};module.seed(0);var F2=0.5*(Math.sqrt(3)-1);var G2=(3-Math.sqrt(3))/6;var F3=1/3;var G3=1/6;module.simplex2=function(xin,yin){var n0,n1,n2;var s=(xin+yin)*F2;var i=Math.floor(xin+s);var j=Math.floor(yin+s);var t=(i+j)*G2;var x0=xin-i+t;var y0=yin-j+t;var i1,j1;if(x0>y0){i1=1;j1=0;}else{i1=0;j1=1;}
var x1=x0-i1+G2;var y1=y0-j1+G2;var x2=x0-1+2*G2;var y2=y0-1+2*G2;i&=255;j&=255;var gi0=gradP[i+perm[j]];var gi1=gradP[i+i1+perm[j+j1]];var gi2=gradP[i+1+perm[j+1]];var t0=0.5-x0*x0-y0*y0;if(t0<0){n0=0;}else{t0*=t0;n0=t0*t0*gi0.dot2(x0,y0);}
var t1=0.5-x1*x1-y1*y1;if(t1<0){n1=0;}else{t1*=t1;n1=t1*t1*gi1.dot2(x1,y1);}
var t2=0.5-x2*x2-y2*y2;if(t2<0){n2=0;}else{t2*=t2;n2=t2*t2*gi2.dot2(x2,y2);}
return 70*(n0+n1+n2);};module.simplex3=function(xin,yin,zin){var n0,n1,n2,n3;var s=(xin+yin+zin)*F3;var i=Math.floor(xin+s);var j=Math.floor(yin+s);var k=Math.floor(zin+s);var t=(i+j+k)*G3;var x0=xin-i+t;var y0=yin-j+t;var z0=zin-k+t;var i1,j1,k1;var i2,j2,k2;if(x0>=y0){if(y0>=z0){i1=1;j1=0;k1=0;i2=1;j2=1;k2=0;}
else if(x0>=z0){i1=1;j1=0;k1=0;i2=1;j2=0;k2=1;}
else{i1=0;j1=0;k1=1;i2=1;j2=0;k2=1;}}else{if(y0<z0){i1=0;j1=0;k1=1;i2=0;j2=1;k2=1;}
else if(x0<z0){i1=0;j1=1;k1=0;i2=0;j2=1;k2=1;}
else{i1=0;j1=1;k1=0;i2=1;j2=1;k2=0;}}
var x1=x0-i1+G3;var y1=y0-j1+G3;var z1=z0-k1+G3;var x2=x0-i2+2*G3;var y2=y0-j2+2*G3;var z2=z0-k2+2*G3;var x3=x0-1+3*G3;var y3=y0-1+3*G3;var z3=z0-1+3*G3;i&=255;j&=255;k&=255;var gi0=gradP[i+perm[j+perm[k]]];var gi1=gradP[i+i1+perm[j+j1+perm[k+k1]]];var gi2=gradP[i+i2+perm[j+j2+perm[k+k2]]];var gi3=gradP[i+1+perm[j+1+perm[k+1]]];var t0=0.6-x0*x0-y0*y0-z0*z0;if(t0<0){n0=0;}else{t0*=t0;n0=t0*t0*gi0.dot3(x0,y0,z0);}
var t1=0.6-x1*x1-y1*y1-z1*z1;if(t1<0){n1=0;}else{t1*=t1;n1=t1*t1*gi1.dot3(x1,y1,z1);}
var t2=0.6-x2*x2-y2*y2-z2*z2;if(t2<0){n2=0;}else{t2*=t2;n2=t2*t2*gi2.dot3(x2,y2,z2);}
var t3=0.6-x3*x3-y3*y3-z3*z3;if(t3<0){n3=0;}else{t3*=t3;n3=t3*t3*gi3.dot3(x3,y3,z3);}
return 32*(n0+n1+n2+n3);};function fade(t){return t*t*t*(t*(t*6-15)+10);}
function lerp(a,b,t){return(1-t)*a+t*b;}
module.perlin2=function(x,y){var X=Math.floor(x),Y=Math.floor(y);x=x-X;y=y-Y;X=X&255;Y=Y&255;var n00=gradP[X+perm[Y]].dot2(x,y);var n01=gradP[X+perm[Y+1]].dot2(x,y-1);var n10=gradP[X+1+perm[Y]].dot2(x-1,y);var n11=gradP[X+1+perm[Y+1]].dot2(x-1,y-1);var u=fade(x);return lerp(lerp(n00,n10,u),lerp(n01,n11,u),fade(y));};module.perlin3=function(x,y,z){var X=Math.floor(x),Y=Math.floor(y),Z=Math.floor(z);x=x-X;y=y-Y;z=z-Z;X=X&255;Y=Y&255;Z=Z&255;var n000=gradP[X+perm[Y+perm[Z]]].dot3(x,y,z);var n001=gradP[X+perm[Y+perm[Z+1]]].dot3(x,y,z-1);var n010=gradP[X+perm[Y+1+perm[Z]]].dot3(x,y-1,z);var n011=gradP[X+perm[Y+1+perm[Z+1]]].dot3(x,y-1,z-1);var n100=gradP[X+1+perm[Y+perm[Z]]].dot3(x-1,y,z);var n101=gradP[X+1+perm[Y+perm[Z+1]]].dot3(x-1,y,z-1);var n110=gradP[X+1+perm[Y+1+perm[Z]]].dot3(x-1,y-1,z);var n111=gradP[X+1+perm[Y+1+perm[Z+1]]].dot3(x-1,y-1,z-1);var u=fade(x);var v=fade(y);var w=fade(z);return lerp(lerp(lerp(n000,n100,u),lerp(n001,n101,u),w),lerp(lerp(n010,n110,u),lerp(n011,n111,u),w),v);};})(window);this.wr=1;this.setWr=()=>{this.wr=(window.innerWidth/1000);if(this.wr>2.1){this.wr=2.1;}
if(this.wr<0.7){this.wr=0.7;}};this.setWr();this.mobile=window.matchMedia("(pointer: coarse)").matches;this.prefersReducedMotion=window.matchMedia("(prefers-reduced-motion: reduce)").matches;this.singleFrameMode=this.mobile||this.prefersReducedMotion;const getCookie=(name)=>{const value=`; ${document.cookie}`;const parts=value.split(`; ${name}=`);if(parts.length===2)return parts.pop().split(';').shift();return null;};const setCookie=(name,value,days=365)=>{const date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));document.cookie=`${name}=${value};expires=${date.toUTCString()};path=/`;};const savedResolutionScale=parseFloat(getCookie('b3d_resolution_scale')||'1.0');const savedTextureResolution=getCookie('b3d_texture_resolution')||'full';this.resolutionScale=Math.max(0.5,Math.min(1.0,savedResolutionScale));this.textureResolution=(savedTextureResolution==='half')?'half':'full';setCookie('b3d_resolution_scale',this.resolutionScale.toString());setCookie('b3d_texture_resolution',this.textureResolution);this.scene=new THREE.Scene();const width=window.innerWidth;const height=window.innerHeight;this.camera=new THREE.PerspectiveCamera(75,width/height,0.1,1000);this.renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});this.renderer.setPixelRatio(window.devicePixelRatio*this.resolutionScale);this.renderer.setSize(width,height);this.renderer.domElement.style.width='100%';this.renderer.domElement.style.height='100%';this.renderer.domElement.style.display='block';this.renderer.domElement.style.position='absolute';this.renderer.domElement.style.top='0';this.renderer.domElement.style.left='0';this.appendChild(this.renderer.domElement);const geometry=new THREE.PlaneBufferGeometry(60,60,20,20);const material=new THREE.MeshPhongMaterial();material.specular=new THREE.Color(0x000000);material.shininess=0;var repeat=10;const manager=new THREE.LoadingManager();manager.onLoad=()=>{material.needsUpdate=true;this.texturesLoaded=true;requestAnimationFrame(()=>{if(!this.hasRenderedInitialFrame&&this.renderer&&this.scene&&this.camera){this.renderer.render(this.scene,this.camera);this.hasRenderedInitialFrame=true;}});if(!this.backgroundRendering){this.stopRendering();}};const textureFolder=this.getAttribute('texture')||'obsidian';const textureBase=`img/${textureFolder}`;const getTexturePath=(filename)=>{if(this.textureResolution==='half'){const halfName=filename.replace('.jpg','_half.jpg');return`${textureBase}/${halfName}`;}
return`${textureBase}/${filename}`;};this.switchTextureResolution=(newResolution)=>{if(newResolution===this.textureResolution)return;if(newResolution!=='full'&&newResolution!=='half')return;const oldResolution=this.textureResolution;this.textureResolution=newResolution;const compensatedRepeat=this.getCompensatedRepeat();const currentMap=material.map;const currentHeightMap=material.heightMap;const currentNormalMap=material.normalMap;const currentRoughnessMap=material.roughnessMap;const currentMetalnessMap=material.metalnessMap;const currentAoMap=material.aoMap;const offsets={map:currentMap?currentMap.offset.clone():null,height:currentHeightMap?currentHeightMap.offset.clone():null,normal:currentNormalMap?currentNormalMap.offset.clone():null,roughness:currentRoughnessMap?currentRoughnessMap.offset.clone():null,metalness:currentMetalnessMap?currentMetalnessMap.offset.clone():null,ao:currentAoMap?currentAoMap.offset.clone():null};this.textures=[];let loadError=false;const loadTextureWithFallback=(path,fallbackPath,onLoad)=>{const loader=new THREE.TextureLoader();loader.load(path,onLoad,undefined,()=>{if(newResolution==='half'&&fallbackPath){loader.load(fallbackPath,onLoad,undefined,()=>{loadError=true;});}else{loadError=true;}});};if(currentMap){const halfPath=getTexturePath('albedo.jpg');const fullPath=`${textureBase}/albedo.jpg`;loadTextureWithFallback(halfPath,fullPath,(texture)=>{texture.wrapS=THREE.RepeatWrapping;texture.wrapT=THREE.RepeatWrapping;texture.repeat.set(compensatedRepeat,compensatedRepeat);if(offsets.map)texture.offset.copy(offsets.map);material.map=texture;material.needsUpdate=true;this.textures.push(texture);});}
if(currentHeightMap){const halfPath=getTexturePath('height.jpg');const fullPath=`${textureBase}/height.jpg`;loadTextureWithFallback(halfPath,fullPath,(heightTexture)=>{heightTexture.wrapS=THREE.RepeatWrapping;heightTexture.wrapT=THREE.RepeatWrapping;heightTexture.repeat.set(compensatedRepeat,compensatedRepeat);if(offsets.height)heightTexture.offset.copy(offsets.height);material.heightMap=heightTexture;material.needsUpdate=true;this.textures.push(heightTexture);});}
if(currentNormalMap){const halfPath=getTexturePath('normal.jpg');const fullPath=`${textureBase}/normal.jpg`;loadTextureWithFallback(halfPath,fullPath,(normal)=>{normal.wrapS=THREE.RepeatWrapping;normal.wrapT=THREE.RepeatWrapping;normal.repeat.set(compensatedRepeat,compensatedRepeat);if(offsets.normal)normal.offset.copy(offsets.normal);material.normalMap=normal;material.needsUpdate=true;this.textures.push(normal);});}
if(currentRoughnessMap){const halfPath=getTexturePath('roughness.jpg');const fullPath=`${textureBase}/roughness.jpg`;loadTextureWithFallback(halfPath,fullPath,(roughness)=>{roughness.wrapS=THREE.RepeatWrapping;roughness.wrapT=THREE.RepeatWrapping;roughness.repeat.set(compensatedRepeat,compensatedRepeat);if(offsets.roughness)roughness.offset.copy(offsets.roughness);material.roughnessMap=roughness;material.needsUpdate=true;this.textures.push(roughness);});}
if(currentMetalnessMap){const halfPath=getTexturePath('metallic.jpg');const fullPath=`${textureBase}/metallic.jpg`;loadTextureWithFallback(halfPath,fullPath,(metalness)=>{metalness.wrapS=THREE.RepeatWrapping;metalness.wrapT=THREE.RepeatWrapping;metalness.repeat.set(compensatedRepeat,compensatedRepeat);if(offsets.metalness)metalness.offset.copy(offsets.metalness);material.metalnessMap=metalness;material.needsUpdate=true;this.textures.push(metalness);});}
if(currentAoMap){const halfPath=getTexturePath('ao.jpg');const fullPath=`${textureBase}/ao.jpg`;loadTextureWithFallback(halfPath,fullPath,(ao)=>{ao.wrapS=THREE.RepeatWrapping;ao.wrapT=THREE.RepeatWrapping;ao.repeat.set(compensatedRepeat,compensatedRepeat);if(offsets.ao)ao.offset.copy(offsets.ao);material.aoMap=ao;material.needsUpdate=true;this.textures.push(ao);});}
if(loadError){this.textureResolution=oldResolution;}else{setCookie('b3d_texture_resolution',this.textureResolution);}};this.textureScrollX=parseFloat(this.getAttribute('texture-scroll-x')||'0');this.textureScrollY=parseFloat(this.getAttribute('texture-scroll-y')||'0');this.textureScrollXElement=this.getAttribute('texture-scroll-x-element')||null;this.textureScrollXScale=parseFloat(this.getAttribute('texture-scroll-x-scale')||'0.0005');this.textureScrollYElement=this.getAttribute('texture-scroll-y-element')||null;this.textureScrollYScale=parseFloat(this.getAttribute('texture-scroll-y-scale')||'0.0005');this.cachedScrollElementX=null;this.cachedScrollElementY=null;this.textureScale=parseFloat(this.getAttribute('texture-scale')||'1');this.baseRepeat=repeat;this.textures=[];this.getCompensatedRepeat=()=>{const baseScaledRepeat=this.baseRepeat/this.textureScale;const widthCompensation=1920/window.innerWidth;return baseScaledRepeat*widthCompensation;};this.updateTextureRepeats=()=>{const compensatedRepeat=this.getCompensatedRepeat();this.textures.forEach(texture=>{if(texture){texture.repeat.set(compensatedRepeat,compensatedRepeat);}});};const compensatedRepeat=this.getCompensatedRepeat();const manifestUrl=`${textureBase}/manifest.json`;let availableTextures=new Set();fetch(manifestUrl).then(response=>{if(response.ok){return response.json();}
return{textures:['albedo.jpg','normal.jpg','height.jpg','roughness.jpg','metallic.jpg','ao.jpg']};}).then(manifest=>{if(manifest&&manifest.textures){manifest.textures.forEach(textureFile=>{availableTextures.add(textureFile);});}
if(availableTextures.has('albedo.jpg')){const texture=new THREE.TextureLoader(manager).load(getTexturePath('albedo.jpg'));texture.wrapS=THREE.RepeatWrapping;texture.wrapT=THREE.RepeatWrapping;texture.repeat.set(compensatedRepeat,compensatedRepeat);material.map=texture;material.needsUpdate=true;this.textures.push(texture);}
if(availableTextures.has('height.jpg')){const heightTexture=new THREE.TextureLoader(manager).load(getTexturePath('height.jpg'));heightTexture.wrapS=THREE.RepeatWrapping;heightTexture.wrapT=THREE.RepeatWrapping;heightTexture.repeat.set(compensatedRepeat,compensatedRepeat);material.heightMap=heightTexture;material.needsUpdate=true;this.textures.push(heightTexture);}
if(availableTextures.has('normal.jpg')){const normal=new THREE.TextureLoader(manager).load(getTexturePath('normal.jpg'));normal.wrapS=THREE.RepeatWrapping;normal.wrapT=THREE.RepeatWrapping;normal.repeat.set(compensatedRepeat,compensatedRepeat);material.normalMap=normal;material.needsUpdate=true;this.textures.push(normal);}
if(availableTextures.has('roughness.jpg')){const roughness=new THREE.TextureLoader(manager).load(getTexturePath('roughness.jpg'));roughness.wrapS=THREE.RepeatWrapping;roughness.wrapT=THREE.RepeatWrapping;roughness.repeat.set(compensatedRepeat,compensatedRepeat);material.roughnessMap=roughness;material.needsUpdate=true;this.textures.push(roughness);}
if(availableTextures.has('metallic.jpg')){const metalnessLoader=new THREE.TextureLoader(manager);metalnessLoader.load(getTexturePath('metallic.jpg'),(metalness)=>{metalness.wrapS=THREE.RepeatWrapping;metalness.wrapT=THREE.RepeatWrapping;const currentCompensatedRepeat=this.getCompensatedRepeat();metalness.repeat.set(currentCompensatedRepeat,currentCompensatedRepeat);material.metalnessMap=metalness;material.needsUpdate=true;this.textures.push(metalness);},undefined,()=>{});}
if(availableTextures.has('ao.jpg')){const aoLoader=new THREE.TextureLoader(manager);aoLoader.load(getTexturePath('ao.jpg'),(ao)=>{ao.wrapS=THREE.RepeatWrapping;ao.wrapT=THREE.RepeatWrapping;const currentCompensatedRepeat=this.getCompensatedRepeat();ao.repeat.set(currentCompensatedRepeat,currentCompensatedRepeat);material.aoMap=ao;material.needsUpdate=true;this.textures.push(ao);},undefined,()=>{});}}).catch(()=>{const texture=new THREE.TextureLoader(manager).load(getTexturePath('albedo.jpg'));texture.wrapS=THREE.RepeatWrapping;texture.wrapT=THREE.RepeatWrapping;texture.repeat.set(compensatedRepeat,compensatedRepeat);material.map=texture;material.needsUpdate=true;this.textures.push(texture);const heightTexture=new THREE.TextureLoader(manager).load(getTexturePath('height.jpg'));heightTexture.wrapS=THREE.RepeatWrapping;heightTexture.wrapT=THREE.RepeatWrapping;heightTexture.repeat.set(compensatedRepeat,compensatedRepeat);material.heightMap=heightTexture;material.needsUpdate=true;this.textures.push(heightTexture);const normal=new THREE.TextureLoader(manager).load(getTexturePath('normal.jpg'));normal.wrapS=THREE.RepeatWrapping;normal.wrapT=THREE.RepeatWrapping;normal.repeat.set(compensatedRepeat,compensatedRepeat);material.normalMap=normal;material.needsUpdate=true;this.textures.push(normal);const roughness=new THREE.TextureLoader(manager).load(getTexturePath('roughness.jpg'));roughness.wrapS=THREE.RepeatWrapping;roughness.wrapT=THREE.RepeatWrapping;roughness.repeat.set(compensatedRepeat,compensatedRepeat);material.roughnessMap=roughness;material.needsUpdate=true;this.textures.push(roughness);});this.plane=new THREE.Mesh(geometry,material);const planeRotationInitial=parseFloat(this.getAttribute('plane-rotation-initial')||'0');this.planeRotationSpeed=parseFloat(this.getAttribute('plane-rotation')||'0');this.plane.rotation.z=planeRotationInitial*(Math.PI/180);const planeDisplacement=parseFloat(this.getAttribute('plane-displacement')||'0');if(planeDisplacement!==0){window.noise.seed(0.4);const vs=this.plane.geometry.attributes.position;for(var i=0;i<vs.count;i++){let x=vs.getX(i);let y=vs.getY(i);let z=vs.getZ(i);z=(window.noise.perlin2(x/3.05,y/3.05)*-planeDisplacement);vs.setXYZ(i,x,y,z);}
vs.needsUpdate=true;this.plane.geometry.computeVertexNormals();}
this.scene.add(this.plane);const getAttr=(name,defaultValue)=>{const value=this.getAttribute(name);return value!==null?value:defaultValue;};const parseColor=(colorStr)=>{if(colorStr.startsWith('#')){return parseInt(colorStr.substring(1),16);}
return parseInt(colorStr,16);};const parseFloatAttr=(str,defaultValue)=>{const parsed=Number.parseFloat(str);return isNaN(parsed)?defaultValue:parsed;};this.lights=[];const lightDefaults=[{color:'0xf5f3c4',intensity:0.5,x:0,y:20,z:10,min:0.3,max:0.6,default:0.5},{color:'0xf2f1d8',intensity:0.3,x:10,y:20,z:10,min:0.15,max:0.35,default:0.3},{color:'0xdedca9',intensity:0.3,x:-5,y:20,z:10,min:0.3,max:0.6,default:0.3},{color:'0x19a3d1',intensity:0.2,x:9,y:0,z:8,min:0.05,max:0.3,default:0.15},{color:'0xc7361e',intensity:0.3,x:-9,y:-15,z:8,min:0.15,max:0.4,default:0.25}];for(let i=0;i<5;i++){const num=i+1;const defaults=lightDefaults[i];const activeAttr=getAttr(`light-${num}-active`,'true');const isActive=activeAttr!=='false'&&activeAttr!=='0';const color=parseColor(getAttr(`light-${num}-color`,defaults.color));const intensity=parseFloatAttr(getAttr(`light-${num}-intensity`,defaults.intensity.toString()),defaults.intensity);const x=parseFloatAttr(getAttr(`light-${num}-position-x`,defaults.x.toString()),defaults.x);const y=parseFloatAttr(getAttr(`light-${num}-position-y`,defaults.y.toString()),defaults.y);let z=parseFloatAttr(getAttr(`light-${num}-position-z`,defaults.z.toString()),defaults.z);let finalX=x;if(num===4||num===5){finalX=x*this.wr;}
const minIntensity=parseFloatAttr(getAttr(`light-${num}-intensity-min`,defaults.min.toString()),defaults.min);const maxIntensity=parseFloatAttr(getAttr(`light-${num}-intensity-max`,defaults.max.toString()),defaults.max);const defaultFlickerRate=num<=3?250:200;const flickerRate=parseFloatAttr(getAttr(`light-${num}-flicker-rate`,defaultFlickerRate.toString()),defaultFlickerRate);const light=new THREE.PointLight(color,intensity);light.position.set(finalX,y,z);light.minIntensity=minIntensity;light.maxIntensity=maxIntensity;light.flickerRate=flickerRate;light.castShadow=true;light.lightNumber=num;if(isActive){this.scene.add(light);this.lights.push(light);}}
const ambientIntensity=parseFloat(this.getAttribute('ambient-light-intensity')||'0.15');if(ambientIntensity>0){const ambientColorStr=this.getAttribute('ambient-light-color')||'0xffffff';const ambientColor=parseColor(ambientColorStr);const ambientLight=new THREE.AmbientLight(ambientColor,ambientIntensity);this.scene.add(ambientLight);}
this.camera.position.z=5*this.wr;window.noise.seed(Math.random());this.lightFlicker=(light,frame,offset,rate)=>{light.intensity=window.noise.perlin2(offset,frame/rate)*(light.maxIntensity-light.minIntensity)+light.minIntensity;};this.lights.forEach((light)=>{const offset=3000+(light.lightNumber*1000);const rate=light.flickerRate||(light.lightNumber<=3?250:200);this.lightFlicker(light,0,offset,rate);});this.updateResolution=(newScale)=>{newScale=Math.max(0.5,Math.min(1.0,newScale));if(newScale!==this.resolutionScale){this.resolutionScale=newScale;setCookie('b3d_resolution_scale',this.resolutionScale.toString());this.renderer.setPixelRatio(window.devicePixelRatio*this.resolutionScale);this.screenResized=true;}};const reportWindowSize=()=>{this.setWr();const width=window.innerWidth;const height=window.innerHeight;this.camera.aspect=width/height;this.camera.position.z=5*this.wr;const light4=this.lights.find(l=>l.lightNumber===4);const light5=this.lights.find(l=>l.lightNumber===5);if(light4){const light4X=parseFloatAttr(getAttr('light-4-position-x','9'),9)*this.wr;light4.position.x=light4X;}
if(light5){const light5X=parseFloatAttr(getAttr('light-5-position-x','-9'),-9)*this.wr;light5.position.x=light5X;}
this.camera.updateProjectionMatrix();this.renderer.setSize(width,height);this.screenResized=true;if(this.updateTextureRepeats){this.updateTextureRepeats();}};this.handleResize=reportWindowSize.bind(this);window.addEventListener('resize',this.handleResize,false);this.clock=new THREE.Clock();this.interval=50;this.maxSlowdownTolerance=3;this.targetTimePerFrame=1/this.interval;this.upperTimePerFrame=this.targetTimePerFrame;this.lowerTimePerFrame=1/(this.interval+5);this.currDelta=0;this.currDeltaCount=0;this.frame=0;this.backgroundRendering=true;this.screenResized=false;this.hasRenderedInitialFrame=false;this.texturesLoaded=false;this.resolutionLevels=[1.0,0.75,0.5];this.currentResolutionLevel=this.resolutionLevels.findIndex(level=>level<=this.resolutionScale);if(this.currentResolutionLevel<0){this.currentResolutionLevel=this.resolutionLevels.length-1;}
this.slowCount=0;this.fastCount=0;this.handleVisibilityChange=()=>{if(document.visibilityState==='visible'){this.clock.getDelta();}};document.addEventListener('visibilitychange',this.handleVisibilityChange);this.render=()=>{const hasFocus=document.hasFocus();const isInitialFrame=!this.hasRenderedInitialFrame;const shouldRender=(isInitialFrame&&this.texturesLoaded)||(this.backgroundRendering&&hasFocus&&!this.singleFrameMode);if(shouldRender){const deltaTime=this.clock.getDelta();if(hasFocus||isInitialFrame){this.frame++;if(this.textures){const normalizeOffset=(offset)=>{if(offset>=1.0){return offset-Math.floor(offset);}else if(offset<=-1.0){return offset-Math.ceil(offset);}
return offset;};const hasElementScrolling=this.textureScrollXElement||this.textureScrollYElement;if(hasElementScrolling){if(this.textureScrollXElement&&!this.cachedScrollElementX){this.cachedScrollElementX=document.querySelector(this.textureScrollXElement);}
if(this.textureScrollYElement&&!this.cachedScrollElementY){this.cachedScrollElementY=document.querySelector(this.textureScrollYElement);}
let textureOffsetX=null;if(this.cachedScrollElementX){const scrollTopX=this.cachedScrollElementX.scrollTop;textureOffsetX=-scrollTopX*this.textureScrollXScale;textureOffsetX=normalizeOffset(textureOffsetX);}
let textureOffsetY=null;if(this.cachedScrollElementY){const scrollTopY=this.cachedScrollElementY.scrollTop;textureOffsetY=-scrollTopY*this.textureScrollYScale;textureOffsetY=normalizeOffset(textureOffsetY);}
this.textures.forEach((tex)=>{if(tex){if(textureOffsetX!==null){tex.offset.x=textureOffsetX;}else if(this.textureScrollX!==0){tex.offset.x+=this.textureScrollX*deltaTime;tex.offset.x=normalizeOffset(tex.offset.x);}
if(textureOffsetY!==null){tex.offset.y=textureOffsetY;}else if(this.textureScrollY!==0){tex.offset.y+=this.textureScrollY*deltaTime;tex.offset.y=normalizeOffset(tex.offset.y);}}});}else if(this.textureScrollX!==0||this.textureScrollY!==0){this.textures.forEach((tex)=>{if(tex){tex.offset.x+=this.textureScrollX*deltaTime;tex.offset.y+=this.textureScrollY*deltaTime;tex.offset.x=normalizeOffset(tex.offset.x);tex.offset.y=normalizeOffset(tex.offset.y);}});}}
if(this.planeRotationSpeed!==0){this.plane.rotation.z+=(this.planeRotationSpeed*(Math.PI/180))*deltaTime;}
this.lights.forEach((light)=>{const offset=3000+(light.lightNumber*1000);const rate=light.flickerRate||(light.lightNumber<=3?250:200);this.lightFlicker(light,this.frame,offset,rate);});if(hasFocus){this.currDelta+=deltaTime;this.currDeltaCount++;}}
this.renderer.render(this.scene,this.camera);if(isInitialFrame&&this.texturesLoaded){this.hasRenderedInitialFrame=true;}}
if(!this.singleFrameMode){requestAnimationFrame(()=>this.render());}};this.performanceInterval=null;if(this.backgroundRendering){this.performanceInterval=setInterval(()=>this.measurePerformance(),5000);}
this.measurePerformance=()=>{if(this.currDeltaCount<=0){return;}
let avgTimePerFrame=(this.currDelta/this.currDeltaCount);if(avgTimePerFrame>this.upperTimePerFrame){this.slowCount++;this.fastCount=0;if(this.slowCount>=2){if(this.resolutionScale<=0.5){if(this.textureResolution==='full'){this.switchTextureResolution('half');}}else{const currentLevel=this.currentResolutionLevel;if(currentLevel<this.resolutionLevels.length-1){this.currentResolutionLevel=currentLevel+1;const newScale=this.resolutionLevels[this.currentResolutionLevel];this.updateResolution(newScale);}
this.slowCount=0;}}}else if(avgTimePerFrame<this.lowerTimePerFrame){this.fastCount++;this.slowCount=0;if(this.fastCount>=3){const currentLevel=this.currentResolutionLevel;if(this.textureResolution==='half'){if(currentLevel>0){this.currentResolutionLevel=currentLevel-1;const newScale=this.resolutionLevels[this.currentResolutionLevel];this.updateResolution(newScale);if(newScale>0.5){this.switchTextureResolution('full');}}else if(this.resolutionScale>0.5){this.switchTextureResolution('full');}}else{if(currentLevel>0){this.currentResolutionLevel=currentLevel-1;const newScale=this.resolutionLevels[this.currentResolutionLevel];this.updateResolution(newScale);}}
this.fastCount=0;}}else{this.slowCount=0;this.fastCount=0;}
if(this.slowCount>=this.maxSlowdownTolerance&&this.resolutionScale<=0.5&&this.textureResolution==='half'){if(this.backgroundRendering){this.stopRendering();window.clearInterval(this.performanceInterval);}
this.slowCount=0;}
this.currDelta=0;this.currDeltaCount=0;};this.stopRendering=()=>{this.backgroundRendering=false;this.lights.forEach(light=>{const offset=3000+(light.lightNumber*1000);const rate=light.flickerRate||(light.lightNumber<=3?250:200);this.lightFlicker(light,this.frame,offset,rate);});this.renderer.render(this.scene,this.camera);};this.render();}
disconnectedCallback(){if(this.handleResize){window.removeEventListener('resize',this.handleResize);}
if(this.handleVisibilityChange){document.removeEventListener('visibilitychange',this.handleVisibilityChange);}
if(this.performanceInterval){window.clearInterval(this.performanceInterval);}}}
customElements.define('b-3d-scene',B3DScene);